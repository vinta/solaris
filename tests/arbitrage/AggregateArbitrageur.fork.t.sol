// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import { IERC20 } from "openzeppelin-contracts/contracts/token/ERC20/IERC20.sol";
import { console } from "forge-std/console.sol";

import { AggregateArbitrageur } from "../../contracts/arbitrage/AggregateArbitrageur.sol";
import { IErrors } from "../../contracts/arbitrage/interfaces/IErrors.sol";
import { ArbitrageFunc } from "../../contracts/arbitrage/enums/ArbitrageFunc.sol";
import { OneInchRouterV5Mixin } from "../../contracts/arbitrage/mixins/OneInchRouterV5Mixin.sol";

import { BaseTest } from "../BaseTest.sol";

contract AggregateArbitrageurForkTest is BaseTest {
    AggregateArbitrageur arbitrageur;
    address owner = makeAddr("owner");

    address WETH = 0x4200000000000000000000000000000000000006;
    address USDCe = 0x7F5c764cBc14f9669B88837ca1490cCa17c31607;
    address OP = 0x4200000000000000000000000000000000000042;
    address UNISWAP_V3_POOL = 0x85149247691df622eaF1a8Bd0CaFd40BC45154a9; // WETH/USDCe 500

    uint256 minProfit = 0;

    // public

    function setUp() public {
        vm.createSelectFork(vm.rpcUrl("optimism"));
        console.log(block.number);

        vm.prank(owner);
        arbitrageur = new AggregateArbitrageur();
    }

    // function testFork_arbitrageOneInchToUniswapV3() public {
    //     _uniswapV3ExactInputSingle(trader, weth, usdc, 100 ether);

    //     uint256 amountIn = 1 ether;
    //     _dealAndApprove(weth, amountIn, owner, address(arbitrageur));

    //     vm.prank(owner);
    //     arbitrageur.arbitrageOneInchToUniswapV3(
    //         weth,
    //         usdc,
    //         1 ether,
    //         0,
    //         500,
    //         // "from": the arbitrageur contract
    //         // "slippage": 5
    //         // "protocols": BASE_MAVERICK
    //         hex"12aa3caf000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd090000000000000000000000004200000000000000000000000000000000000006000000000000000000000000d9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd0900000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea0000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000006e1f00380000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000014e000000000000000000000000000000000000000000000000000000000130512001538aa697ce8cc8252c70c41452dae86ce22a3e420000000000000000000000000000000000000600a4a5dcbcdf0000000000000000000000004200000000000000000000000000000000000006000000000000000000000000d9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca00000000000000000000000006e6736ca9e922766279a22b75a600fe8b8473b60000000000000000000000001111111254eeb25477b68fb85ed929f73a960582ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008b1ccac8"
    //     );

    //     assertEq(IERC20(weth).balanceOf(address(owner)) > amountIn, true);
    // }

    // function testFork_arbitrageOneInchToUniswapV3_RevertIf_NoProfit() public {
    //     console.logAddress(owner);

    //     _dealAndApprove(WETH, 1 ether, owner, address(arbitrageur));

    //     // vm.expectRevert(abi.encodeWithSelector(IErrors.NoProfit.selector));
    //     vm.prank(owner);
    //     arbitrageur.arbitrageOneInchRouterV5(
    //         WETH,
    //         USDCe,
    //         1 ether,
    //         0,
    //         // "from" should be the arbitrageur contract
    //         hex"12aa3caf000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd090000000000000000000000004200000000000000000000000000000000000006000000000000000000000000d9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca000000000000000000000000e37e799d5077682fa0a244d46e5649f71457bd0900000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea0000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000073c7e157000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000160000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a500000000000000000000000000000000000000000000000000000000028700a0c9e75c480000000000001f0a06030000000000000000000000000000000000000002590001f60000c600006302a00000000000000000000000000000000000000000000000000000000006e08503ee63c1e581ef3c164b0fee8eb073513e88ecea280a58cc994542000000000000000000000000000000000000061111111254eeb25477b68fb85ed929f73a96058202a0000000000000000000000000000000000000000000000000000000000dc0f9a8ee63c1e581e58b73ff901325b8b2056b29712c50237242f52042000000000000000000000000000000000000061111111254eeb25477b68fb85ed929f73a960582510001538aa697ce8cc8252c70c41452dae86ce22a3e420000000000000000000000000000000000000600a4a5dcbcdf0000000000000000000000004200000000000000000000000000000000000006000000000000000000000000d9aaec86b65d86f6a7b5b1b0c42ffa531710b6ca00000000000000000000000006e6736ca9e922766279a22b75a600fe8b8473b60000000000000000000000001111111254eeb25477b68fb85ed929f73a960582ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002a000000000000000000000000000000000000000000000000000000000471146b4ee63c1e5814c36388be6f416a29c8d8eee81c771ce6be14b1842000000000000000000000000000000000000061111111254eeb25477b68fb85ed929f73a9605820000000000000000000000000000000000000000000000000000008b1ccac8",
    //         ArbitrageFunc.VelodromeV2Router
    //     );
    // }

    function testFork_arbitrageOneInchToUniswapV3_RevertIf_SwapFail() public {
        _dealAndApprove(WETH, 1 ether, owner, address(arbitrageur));

        // "from" should be the arbitrageur contract
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea0000000000000000000000000000000000000000000000000de0b6b3a7640000000000000000000000000000000000000000000000000000000000003c3f27180000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff23502527024420000000000000000000000000000000000000600447dc2038200000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000003c3f27180000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.expectRevert(abi.encodeWithSelector(OneInchRouterV5Mixin.OneInchSwapFail.selector));
        vm.prank(owner);
        arbitrageur.arbitrageOneInchRouterV5(
            UNISWAP_V3_POOL,
            WETH,
            USDCe,
            1 ether,
            minProfit,
            oneInchData,
            ArbitrageFunc.VelodromeV2Router
        );
    }
}
