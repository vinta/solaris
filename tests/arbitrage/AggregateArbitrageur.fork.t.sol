// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import { IERC20 } from "openzeppelin-contracts/contracts/token/ERC20/IERC20.sol";
import { console } from "forge-std/console.sol";

import { IErrors } from "../../contracts/arbitrage/interfaces/IErrors.sol";
import { AggregateArbitrageur } from "../../contracts/arbitrage/AggregateArbitrageur.sol";
import { OneInchRouterV5Mixin } from "../../contracts/arbitrage/mixins/OneInchRouterV5Mixin.sol";

import { BaseTest } from "../BaseTest.sol";

contract AggregateArbitrageurForkTest is BaseTest {
    AggregateArbitrageur arbitrageur;
    address owner = makeAddr("owner");

    address WETH = 0x4200000000000000000000000000000000000006;
    address USDCe = 0x7F5c764cBc14f9669B88837ca1490cCa17c31607;
    address OP = 0x4200000000000000000000000000000000000042;
    address UNISWAP_V3_POOL = 0x85149247691df622eaF1a8Bd0CaFd40BC45154a9; // WETH/USDCe 500

    uint256 minProfit = 0;

    // public

    function setUp() public {
        vm.createSelectFork(vm.rpcUrl("optimism"), 112538453);
        console.log(block.number);

        vm.prank(owner);
        arbitrageur = new AggregateArbitrageur();
    }

    // arbitrageUniswapV3FlashSwap

    function testFork_arbitrageUniswapV3FlashSwap() public {
        _uniswapV3ExactInputSingle(trader, USDCe, WETH, 200000e6);

        // src: USDCe
        // dst: WETH
        // amount: 2052736264
        // from: the arbitrageur contract
        // slippage: 5
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea000000000000000000000000000000000000000000000000000000007a5a45080000000000000000000000000000000000000000000000000d5b54a3212b590e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff235025270247f5c764cbc14f9669b88837ca1490cca17c3160700447dc203820000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000d5b54a3212b590e0000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.prank(owner);
        arbitrageur.arbitrageUniswapV3FlashSwap(UNISWAP_V3_POOL, WETH, USDCe, 1 ether, minProfit, oneInchData);
    }

    function testFork_arbitrageUniswapV3FlashSwap_RevertIf_OneInchSwapFail() public {
        _uniswapV3ExactInputSingle(trader, USDCe, WETH, 200000e6);

        // src: USDCe
        // dst: WETH
        // amount: 2052736264
        // from: the arbitrageur contract
        // slippage: 0
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea000000000000000000000000000000000000000000000000000000007a5a45080000000000000000000000000000000000000000000000000e0c05b1358aad800000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff235025270247f5c764cbc14f9669b88837ca1490cca17c3160700447dc203820000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de80fe013b9ee530000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.expectRevert(abi.encodeWithSelector(OneInchRouterV5Mixin.OneInchSwapFail.selector));
        vm.prank(owner);
        arbitrageur.arbitrageUniswapV3FlashSwap(UNISWAP_V3_POOL, WETH, USDCe, 1 ether, minProfit, oneInchData);
    }
}
