// SPDX-License-Identifier: MIT
pragma solidity 0.8.19;

import { IERC20 } from "openzeppelin-contracts/contracts/token/ERC20/IERC20.sol";
import { console } from "forge-std/console.sol";

import { IErrors } from "../../contracts/arbitrage/interfaces/IErrors.sol";
import { FlashAggregateArbitrageur } from "../../contracts/arbitrage/FlashAggregateArbitrageur.sol";
import { OneInchRouterV5Mixin } from "../../contracts/arbitrage/mixins/OneInchRouterV5Mixin.sol";

import { BaseTest } from "../BaseTest.sol";

contract FlashAggregateArbitrageurForkTest is BaseTest {
    FlashAggregateArbitrageur arbitrageur;
    address owner = makeAddr("owner");

    address WETH = 0x4200000000000000000000000000000000000006;
    address USDCe = 0x7F5c764cBc14f9669B88837ca1490cCa17c31607;
    address OP = 0x4200000000000000000000000000000000000042;
    address UNISWAP_V3_POOL = 0x85149247691df622eaF1a8Bd0CaFd40BC45154a9; // WETH/USDCe 500

    uint256 minProfit = 0;

    // public

    function setUp() public {
        vm.createSelectFork(vm.rpcUrl("optimism"), 112538453);
        console.log(block.number);

        vm.prank(owner);
        arbitrageur = new FlashAggregateArbitrageur();
    }

    // arbitrageOneInch

    function testFork_arbitrageOneInch() public {
        _uniswapV3ExactInputSingle(trader, WETH, USDCe, 50 ether);

        // src: WETH
        // dst: USDCe
        // amount: 2000000000000000000
        // from: the arbitrageur contract
        // slippage: 5
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea0000000000000000000000000000000000000000000000001bc16d674ec8000000000000000000000000000000000000000000000000000000000000e5f5555f0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff23502527024420000000000000000000000000000000000000600447dc2038200000000000000000000000042000000000000000000000000000000000000060000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000e5f5555f0000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.prank(owner);
        uint256 profit = arbitrageur.arbitrageOneInch(WETH, USDCe, 2 ether, minProfit, oneInchData, 500);

        assertEq(IERC20(WETH).balanceOf(address(arbitrageur)), 8065015023920614);
        assertEq(IERC20(WETH).balanceOf(address(arbitrageur)), profit);
    }

    function testFork_arbitrageOneInch_2() public {
        _uniswapV3ExactInputSingle(trader, USDCe, WETH, 200000e6);

        // src: USDCe
        // dst: WETH
        // amount: 4000000000
        // from: the arbitrageur contract
        // slippage: 5
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea00000000000000000000000000000000000000000000000000000000ee6b280000000000000000000000000000000000000000000000000019dc1c7f437fcd1c0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff235025270247f5c764cbc14f9669b88837ca1490cca17c3160700447dc203820000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000019dc1c7f437fcd1c0000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.prank(owner);
        uint256 profit = arbitrageur.arbitrageOneInch(USDCe, WETH, 4000e6, minProfit, oneInchData, 500);

        assertEq(IERC20(USDCe).balanceOf(address(arbitrageur)), 34062020);
        assertEq(IERC20(USDCe).balanceOf(address(arbitrageur)), profit);
    }

    // arbitrageUniswapV3

    function testFork_arbitrageUniswapV3() public {
        _uniswapV3ExactInputSingle(trader, USDCe, WETH, 200000e6);

        // src: USDCe
        // dst: WETH
        // amount: 2052736264
        // from: the arbitrageur contract
        // slippage: 5
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea000000000000000000000000000000000000000000000000000000007a5a45080000000000000000000000000000000000000000000000000d5b54a3212b590e0000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff235025270247f5c764cbc14f9669b88837ca1490cca17c3160700447dc203820000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000d5b54a3212b590e0000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.prank(owner);
        uint256 profit = arbitrageur.arbitrageUniswapV3(UNISWAP_V3_POOL, WETH, USDCe, 1 ether, minProfit, oneInchData);

        assertEq(IERC20(WETH).balanceOf(address(arbitrageur)), 8579303985551139);
        assertEq(IERC20(WETH).balanceOf(address(arbitrageur)), profit);
    }

    function testFork_arbitrageUniswapV3_RevertIf_OneInchSwapFail() public {
        _uniswapV3ExactInputSingle(trader, USDCe, WETH, 200000e6);

        // src: USDCe
        // dst: WETH
        // amount: 2052736264
        // from: the arbitrageur contract
        // slippage: 0
        // protocols: OPTIMISM_ONE_INCH_LIMIT_ORDER_V3,OPTIMISM_VELODROME_V2,OPTIMISM_WOOFI_V2,OPTIMISM_MUMMY_FINANCE
        bytes
            memory oneInchData = hex"12aa3caf000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba0000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000004200000000000000000000000000000000000006000000000000000000000000b63aae6c353636d66df13b89ba4425cfe13d10ba00000000000000000000000088f59f8826af5e695b13ca934d6c7999875a9eea000000000000000000000000000000000000000000000000000000007a5a45080000000000000000000000000000000000000000000000000e0c05b1358aad800000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010e0000000000000000000000000000000000000000000000000000000000f05120eaf1ac8e89ea0ae13e0f03634a4ff235025270247f5c764cbc14f9669b88837ca1490cca17c3160700447dc203820000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000420000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000de80fe013b9ee530000000000000000000000001111111254eeb25477b68fb85ed929f73a96058200000000000000000000000042f527f50f16a103b6ccab48bccca214500c10210000000000000000000000000000000000008b1ccac8";

        vm.expectRevert(abi.encodeWithSelector(OneInchRouterV5Mixin.OneInchSwapFail.selector));
        vm.prank(owner);
        arbitrageur.arbitrageUniswapV3(UNISWAP_V3_POOL, WETH, USDCe, 1 ether, minProfit, oneInchData);
    }
}
